<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Whitelist</title>
	<style>.sort {
/*   color: #0f0; */
}

.asc:after {
  content: ' \2191';
}

.desc:after {
  content: ' \2193';
}

/* .asc {
      transform: rotate(-135deg);
    -webkit-transform: rotate(-135deg);
} */

.desc {
  

}
</style>
</head>

<body>
	<div class="container">
  <div class="row">
    <div class="col-md-4">
        <input id="search" type="text" class="form-control" placeholder="Search..." aria-describedby="search">
    </div>  
  </div>
  <div class="row">
  <table class="table" id="users">
  </table>
  </div>  
</div>

	<script>// Fetch Users
// fetchUsers = endpoint => {
//   fetch(endpoint)
//     .then(response => response.json())
//     .then(data => createUsersTable(data))
//     .then(() => addSort())
//     .catch(err => console.error(err));
// };

const fetchUsers = async endpoint => {
  const res = await fetch(endpoint);
  let data = await res.json();
  
  data = data.map(({id, username, name, email}) => ({
    id,
    username,
    name,
    email,
  }));
  
  createUsersTable(data);
  addSort();
  
  
  // fetch(endpoint)
  //   .then(response => response.json())
  //   .then(data => createUsersTable(data))
  //   .then(() => addSort())
  //   .catch(err => console.error(err));
};

// Build table data
createUsersTable = users => {
  const table = document.querySelector("#users");
  const headers = Object.keys(users[0]);
  const tableHeaders = [];
  const sortable = ['name', 'username'];

  headers.forEach(header => {
    if (typeof users[0][header] !== "object") {
      const textEl = document.createTextNode(header);
      const th = document.createElement("th");
      th.appendChild(textEl);
      if(sortable.indexOf(header) > -1) {
        th.className = 'sort asc';
      }
      tableHeaders.push(th);
    }
  });

  table.appendChild(document.createElement("thead")).append(...tableHeaders);
  table.appendChild(document.createElement("tbody"));

  // Create new row in table for each user
  users.forEach(user => {
    const tableRow = document.createElement("tr");

    //Create table data for user attributes
    const tableData = [];
    headers.forEach(key => {
      if (typeof user[key] !== "object") {
        const userData = document.createElement("td");
        userData.className = [key];
        userData.appendChild(document.createTextNode(user[key]));
        tableData.push(userData);
      }
    });

    tableRow.append(...tableData);
    document.querySelector("table tbody").appendChild(tableRow);
  });
};

const filterResults = e => {
  const searchCriteria = e.target.value.toLowerCase();

  // Iterate over users object to filter
  const tableRows = document.querySelector("#users");
  const usersRowArray = Array.from(tableRows.getElementsByTagName("tr"));
  usersRowArray.forEach(row => {
    // row.children[1].
    if (row.children[1].textContent.toLowerCase().includes(searchCriteria)) {
      row.style.display = "";
    } else {
      row.style.display = "none";
    }
  });
};

const searchInput = document.querySelector("#search");
searchInput.addEventListener("keyup", filterResults);
fetchUsers('https://jsonplaceholder.typicode.com/users');

// Add sort functionality on headers
const addSort = () => {
const sortBy = document.querySelectorAll(".sort");
  sortBy.forEach(header => {
    header.addEventListener('click', sort);
  });
  
  // toggleClassName
}

const sort = (event) => {
  const sortByType = event.target.textContent;
  const sortAscending = event.target.className.indexOf('asc') > -1;
  console.log('event',);
  // Get all the table rows as an array
  const tableRows = Array.from(document.querySelectorAll('tr'));
  
  // run the sorting fn on all the rows

  const sortByHeaderAsc = (row1, row2) => {
    const row1ChildNodes = Array.from(row1.childNodes).find( node => node.className === sortByType);
    const row2ChildNodes = Array.from(row2.childNodes).find( node => node.className === sortByType);
    const compare1 = row1ChildNodes.textContent.toLowerCase();
    const compare2 = row2ChildNodes.textContent.toLowerCase();

    if (compare1 > compare2) {
      return 1;
    } else if (compare1 < compare2) {
      return -1;
    } else if(compare1 === compare2) {
      return 0;
    }
  }
  
    const sortByHeaderDesc = (row1, row2) => {
    const row1ChildNodes = Array.from(row1.childNodes).find( node => node.className === sortByType);
    const row2ChildNodes = Array.from(row2.childNodes).find( node => node.className === sortByType);
    const compare1 = row1ChildNodes.textContent.toLowerCase();
    const compare2 = row2ChildNodes.textContent.toLowerCase();

    if (compare1 < compare2) {
      return 1;
    } else if (compare1 > compare2) {
      return -1;
    } else if(compare1 === compare2) {
      return 0;
    }
  }
  
  // Run a sorting function on them by header type
    if(sortAscending) {
      tableRows.sort(sortByHeaderAsc);
    } else {
      tableRows.sort(sortByHeaderDesc); 
    }
  
  // Toggle sorting 
  if(sortAscending) {
  event.target.className = 'sort desc';
  } else {
  event.target.className = 'sort asc';
  }
  // const tableHeader = document.querySe
  const tableBody = document.querySelector('table');
  const oldTableBody = document.querySelector('tbody');
  const newTableBody = document.createElement('tbody');
  tableRows.forEach(row => 
                   newTableBody.appendChild(row));
   tableBody.replaceChild(newTableBody, oldTableBody);
}
</script>
</body>
</html>
